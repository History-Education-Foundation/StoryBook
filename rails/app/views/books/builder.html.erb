<% content_for :header, "" %>

<div data-page-type="books_builder" data-resource="books" data-action="builder" style="display: none;"></div>

<style>
  .editable-field {
    position: relative;
    transition: all 0.2s ease;
  }
  
  .editable-field:hover {
    background-color: #f0f9ff;
    outline: 2px dashed #bfdbfe;
    outline-offset: 2px;
  }
  
  .edit-mode input,
  .edit-mode textarea {
    border: 2px solid #3b82f6 !important;
    background-color: #eff6ff !important;
  }
  
  .edit-btn {
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .editable-field:hover .edit-btn {
    opacity: 1;
  }
  
  .edit-mode {
    overflow: visible !important;
  }
  
  .edit-mode .flex.gap-2.mt-2 {
    display: flex !important;
    position: relative;
    z-index: 10;
  }
  
  .saving-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #fbbf24;
    margin-left: 8px;
    animation: pulse 1s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .saved-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #10b981;
    margin-left: 8px;
  }
  

</style>

<div class="fixed top-4 left-4 z-50">
  <%= link_to books_path, class: "btn gap-2 btn-sm", style: "background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe;" do %>
    <i class="fas fa-arrow-left"></i>
    <span class="hidden sm:inline">Books</span>
  <% end %>
</div>

<div class="max-w-2xl mx-auto mt-10 bg-white p-8 rounded shadow" id="book-builder-container" data-book-id="<%= @book.id %>" data-llama-no-chat-bubble="true">
  <div class="mb-6">
    <div>
      <% ix = 1 %>
      
      <!-- Book Title (Editable) -->
      <div class="editable-field mb-4 p-3 rounded cursor-pointer group" data-field="title" data-resource-type="book" data-resource-id="<%= @book.id %>">
        <div class="flex items-start justify-between gap-3">
          <h1 class="text-3xl font-bold flex-1 editable-content" data-read-ix="0"><%= @book.title %></h1>
          <button class="edit-btn btn btn-xs btn-ghost gap-1" onclick="startEdit(this)">
            <i class="fas fa-pen-to-square"></i>
          </button>
        </div>
      </div>
      
      <!-- Book Metadata -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <!-- Reading Level Selector (Editable) -->
        <div class="editable-field px-3 py-2 rounded cursor-pointer group inline-flex items-center gap-2" style="background-color: #e0e7ff; border: 2px solid #c7d2fe; flex-shrink: 0;" data-field="reading_level" data-resource-type="book" data-resource-id="<%= @book.id %>">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 editable-content" style="color: #4338ca; white-space: nowrap;">
              <i class="fas fa-book-reader"></i>
              <span><%= @book.reading_level.presence || 'Select level' %></span>
            </div>
            <button class="edit-btn btn btn-xs btn-ghost gap-0 p-1" onclick="startEdit(this)">
              <i class="fas fa-pen-to-square"></i>
            </button>
          </div>
        </div>
        
        <div class="badge badge-lg flex-shrink-0" style="background-color: #fef3c7; color: #b45309; border-color: #fde68a;">
          <i class="fas fa-edit"></i>
          Builder Mode
        </div>
      </div>
      
      <!-- Learning Outcome (Editable) -->
      <div class="editable-field bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg border-l-4 mb-4 cursor-pointer group" style="border-left-color: #818cf8;" data-field="learning_outcome" data-resource-type="book" data-resource-id="<%= @book.id %>">
        <div class="flex items-start justify-between gap-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <i class="fas fa-bullseye text-indigo-600 mt-1"></i>
              <span class="font-semibold text-indigo-900">Learning Outcome:</span>
            </div>
            <div class="text-gray-700 text-sm ml-6 editable-content">
              <%= simple_format(@book.learning_outcome) %>
            </div>
          </div>
          <button class="edit-btn btn btn-xs btn-ghost gap-1" onclick="startEdit(this)">
            <i class="fas fa-pen-to-square"></i>
          </button>
        </div>
      </div>

      <% @chapters.each do |chapter| %>
        <div class="mt-10 chapter-builder-block" data-chapter-id="<%= chapter.id %>">
          <!-- Chapter Header (Editable) -->
          <div class="editable-field mb-6 pb-3 border-b-2 rounded p-3 cursor-pointer group" style="border-color: #c7d2fe;" data-field="title" data-resource-type="chapter" data-resource-id="<%= chapter.id %>">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <h2 class="text-2xl font-semibold mb-2 text-indigo-900 editable-content" data-read-ix="<%= ix %>"><%= chapter.title %></h2>
                <% ix += 1 %>
              </div>
              <button class="edit-btn btn btn-xs btn-ghost gap-1" onclick="startEdit(this)">
                <i class="fas fa-pen-to-square"></i>
              </button>
            </div>
          </div>

          <!-- Chapter Description (Editable) -->
          <div class="editable-field mb-4 p-3 rounded cursor-pointer group text-gray-600 text-sm" data-field="description" data-resource-type="chapter" data-resource-id="<%= chapter.id %>">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 editable-content">
                <%= simple_format(chapter.description) %>
              </div>
              <button class="edit-btn btn btn-xs btn-ghost gap-1" onclick="startEdit(this)">
                <i class="fas fa-pen-to-square"></i>
              </button>
            </div>
          </div>

          <% chapter.pages.order(:id).each do |page| %>
            <div class="my-6 p-6 rounded-lg" style="background: linear-gradient(to bottom right, #ffffff, #faf5ff);" data-page-id="<%= page.id %>">
              <!-- Image Management Section -->
              <div class="mb-6 relative" id="image-container-<%= page.id %>">
                <% if page.image.attached? %>
                  <!-- Image Display with Overlay -->
                  <div class="flex justify-center relative group">
                    <%= image_tag url_for(page.image), class: "rounded-lg border-2 max-h-80 object-contain transition-all duration-200", style: "border-color: #e0e7ff;", loading: "lazy", alt: "", id: "page-image-#{page.id}" %>
                    <!-- Delete Overlay on Hover -->
                    <div class="absolute inset-0 bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                      <button type="button" class="btn btn-sm gap-1" style="background-color: #ef4444; color: white; border-color: #dc2626;" onclick="deletePageImage(<%= page.id %>)">
                        <i class="fas fa-trash"></i>
                        Delete
                      </button>
                    </div>
                  </div>
                <% else %>
                  <!-- Placeholder -->
                  <div class="flex justify-center mb-4">
                    <div class="rounded-lg border-2 border-dashed p-8 text-center" style="border-color: #e0e7ff; background-color: #f3f4f6; width: 100%; max-width: 400px;">
                      <i class="fas fa-image text-4xl mb-2" style="color: #9ca3af;"></i>
                      <p class="text-gray-500 text-sm">No image yet</p>
                    </div>
                  </div>
                <% end %>

                <!-- Image Action Buttons -->
                <div class="flex justify-center gap-2 flex-wrap mt-4" id="image-actions-<%= page.id %>">
                  <!-- Upload Button -->
                  <button type="button" class="btn btn-sm gap-1" style="background-color: #f59e0b; color: white; border-color: #d97706;" onclick="document.getElementById('file-input-<%= page.id %>').click()">
                    <i class="fas fa-cloud-arrow-up"></i>
                    Upload
                  </button>
                  <input type="file" id="file-input-<%= page.id %>" class="hidden" accept="image/*" onchange="uploadPageImage(<%= page.id %>, event)">

                  <!-- Loading Indicator (hidden by default) -->
                  <span id="loading-<%= page.id %>" class="hidden inline-flex items-center gap-2 text-amber-600 text-sm font-medium">
                    <span class="inline-block border-2 border-amber-200 border-t-amber-600 rounded-full w-4 h-4 animate-spin"></span>
                    Processing...
                  </span>
                </div>
              </div>

              <!-- AI Image Generation Form -->
              <div class="mb-6 mt-6 relative flex flex-col items-center">
                <div class="text-center mb-3 text-gray-700 font-semibold text-sm">OR generate an image with AI</div>
                <div class="w-full">
                  <div class="mb-3">
                    <label for="image_description_<%= page.id %>" class="block text-sm font-medium text-gray-700 mb-2">Describe the image you want</label>
                    <textarea id="image_description_<%= page.id %>" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-y" rows="3" placeholder="Enter a description of the image..."><%= page.content.presence || '' %></textarea>
                  </div>
                  <button type="button" class="w-full rounded-lg bg-indigo-600 py-2 px-4 text-white font-semibold hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 flex items-center justify-center gap-2" onclick="submitBuilderGenerateImage(<%= page.id %>)">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    Generate Image
                  </button>
                </div>
              </div>

              <!-- Page Content (Editable) -->
              <div class="editable-field p-3 rounded cursor-pointer group text-base text-gray-800 whitespace-pre-line leading-relaxed" data-field="content" data-resource-type="page" data-resource-id="<%= page.id %>" data-read-ix="<%= ix %>">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1 editable-content">
                    <%= page.content %>
                  </div>
                  <button class="edit-btn btn btn-xs btn-ghost gap-1" onclick="startEdit(this)">
                    <i class="fas fa-pen-to-square"></i>
                  </button>
                </div>
              </div>

              <div class="mt-4 p-3 rounded-lg flex items-center gap-2" style="background-color: #fef3c7; border: 1px solid #fde68a;">
                <i class="fas fa-info-circle text-amber-600"></i>
                <span class="text-sm text-amber-800">Audio is only available for published books.</span>
              </div>
            </div>
            <% ix += 1 %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Chat Bubble -->
<%= render 'public/chat_bubble' %>

<%= javascript_include_tag "llama_bot_rails/application" %>
<% if defined?(action_cable_meta_tag) %>
  <%= action_cable_meta_tag %>
<% end %>
<link rel="stylesheet" href="https://unpkg.com/@tailwindcss/typography@0.4.x/dist/typography.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
// Inline Editing System
function startEdit(button) {
  const field = button.closest('.editable-field');
  if (!field) return;
  
  field.classList.add('edit-mode');
  
  const content = field.querySelector('.editable-content');
  const fieldName = field.dataset.field;
  const resourceType = field.dataset.resourceType;
  const resourceId = field.dataset.resourceId;
  const originalText = content.innerText.trim();
  
  // Check if this is a reading_level field (needs special handling)
  let input;
  if (fieldName === 'reading_level') {
    // Create select element for reading level
    input = document.createElement('select');
    input.className = 'w-full p-2 border-2 border-indigo-500 rounded bg-blue-50 text-gray-800';
    const levels = ['7th Grade', '8th Grade', '9th Grade', '10th Grade', '11th Grade', '12th Grade'];
    const promptOption = document.createElement('option');
    promptOption.value = '';
    promptOption.textContent = 'Select reading level';
    input.appendChild(promptOption);
    levels.forEach(level => {
      const option = document.createElement('option');
      option.value = level;
      option.textContent = level;
      if (level === originalText) {
        option.selected = true;
      }
      input.appendChild(option);
    });
  } else {
    // Determine if we need a textarea or input
    const isLongText = originalText.length > 100 || originalText.includes('\n');
    const inputType = isLongText ? 'textarea' : 'input';
    
    // Create input element
    input = document.createElement(inputType);
    input.className = 'w-full p-2 border-2 border-indigo-500 rounded bg-blue-50 text-gray-800';
    input.value = originalText;
    
    if (inputType === 'textarea') {
      input.rows = Math.max(3, Math.ceil(originalText.length / 60));
      input.style.fontFamily = 'inherit';
      input.style.fontSize = 'inherit';
      input.style.lineHeight = 'inherit';
    }
  }
  
  // Replace content
  content.innerHTML = '';
  content.appendChild(input);
  input.focus();
  if (input.select) input.select();
  
  // Replace button with save/cancel (place outside the content div)
  button.style.display = 'none';
  const actions = document.createElement('div');
  actions.className = 'flex gap-2 mt-3';
  actions.style.cssText = 'display: flex !important; gap: 0.5rem; margin-top: 0.75rem;';
  
  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.className = 'btn btn-sm gap-1';
  saveBtn.style.cssText = 'background-color: #d1fae5; color: #047857; border: 1px solid #a7f3d0; padding: 0.5rem 1rem; font-size: 0.875rem; display: inline-flex !important; cursor: pointer;';
  saveBtn.innerHTML = '<i class="fas fa-check"></i> Save';
  saveBtn.addEventListener('click', (e) => {
    e.preventDefault();
    console.log('Save button clicked');
    saveEdit(saveBtn);
  });
  
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.className = 'btn btn-sm gap-1';
  cancelBtn.style.cssText = 'background-color: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; padding: 0.5rem 1rem; font-size: 0.875rem; display: inline-flex !important; cursor: pointer;';
  cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
  cancelBtn.addEventListener('click', (e) => {
    e.preventDefault();
    console.log('Cancel button clicked');
    cancelEdit(cancelBtn);
  });
  
  actions.appendChild(saveBtn);
  actions.appendChild(cancelBtn);
  // Append actions to the field, not nested in flex
  field.appendChild(actions);
  
  // Handle Enter key to save (only for single-line inputs, not select)
  if (input.tagName !== 'SELECT' && input.tagName !== 'TEXTAREA') {
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        saveEdit(actions.querySelector('.btn-success'));
      }
    });
  }
  
  // Handle Escape to cancel
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      cancelEdit(actions.querySelector('.btn-outline'));
    }
  });
}

function saveEdit(button) {
  console.log('=== SAVE EDIT START ===');
  const actions = button.closest('.flex');
  console.log('actions:', actions);
  const field = actions.closest('.editable-field');
  console.log('field:', field);
  
  const input = field.querySelector('input, textarea, select');
  console.log('input:', input);
  if (!input) {
    console.error('ERROR: Could not find input, textarea, or select');
    alert('Error: Could not find input field');
    return;
  }
  
  const newValue = input.value.trim();
  const fieldName = field.dataset.field;
  const resourceType = field.dataset.resourceType;
  const resourceId = field.dataset.resourceId;
  
  console.log('Values:', { newValue, fieldName, resourceType, resourceId });
  
  // Show saving indicator
  showSaving(button);
  
  // Determine endpoint and prepare payload with proper nesting
  let endpoint = '';
  let payload = {};
  const bookId = document.querySelector('#book-builder-container').dataset.bookId;
  
  if (resourceType === 'book') {
    endpoint = `/books/${bookId}`;
    payload = { book: { [fieldName]: newValue } };
  } else if (resourceType === 'chapter') {
    endpoint = `/books/${bookId}/chapters/${resourceId}`;
    payload = { chapter: { [fieldName]: newValue } };
  } else if (resourceType === 'page') {
    const chapterId = field.closest('.chapter-builder-block').dataset.chapterId;
    endpoint = `/books/${bookId}/chapters/${chapterId}/pages/${resourceId}`;
    payload = { page: { [fieldName]: newValue } };
  }
  
  // Send PATCH request
  const csrfElement = document.querySelector('[name="csrf-token"]');
  console.log('CSRF element found:', csrfElement);
  const csrfToken = csrfElement ? csrfElement.content : null;
  console.log('CSRF token:', csrfToken ? 'present' : 'MISSING');
  console.log('Endpoint:', endpoint);
  console.log('Payload:', payload);
  
  if (!csrfToken) {
    alert('ERROR: CSRF token not found. Page may not be loaded correctly.');
    return;
  }
  
  // Request JSON response by appending .json to endpoint
  const jsonEndpoint = endpoint + '.json';
  
  // Create FormData instead of JSON for better Rails compatibility
  const formData = new FormData();
  
  // Flatten the payload into FormData
  if (resourceType === 'book') {
    formData.append('book[' + fieldName + ']', newValue);
  } else if (resourceType === 'chapter') {
    formData.append('chapter[' + fieldName + ']', newValue);
  } else if (resourceType === 'page') {
    formData.append('page[' + fieldName + ']', newValue);
  }
  
  // Add authenticity token
  formData.append('authenticity_token', csrfToken);
  
  console.log('Sending FormData with:', fieldName, '=', newValue);
  console.log('Target endpoint:', jsonEndpoint);
  
  fetch(jsonEndpoint, {
    method: 'PATCH',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: formData
  })
  .then(res => {
    console.log('Response received:', res.status, res.ok);
    if (res.ok) {
      console.log('Save successful!');
      // Success - update DOM
      const content = field.querySelector('.editable-content');
      if (fieldName === 'reading_level') {
        // For reading level, just show the selected value
        content.innerHTML = '<i class="fas fa-book-reader"></i><span>' + newValue + '</span>';
      } else {
        content.innerHTML = newValue.replace(/\n/g, '<br>');
      }
      field.classList.remove('edit-mode');
      // Remove the actions div
      const actions = field.querySelector('.flex.gap-2.mt-3');
      if (actions) actions.remove();
      // Show edit button again
      const editBtn = field.querySelector('.edit-btn');
      if (editBtn) editBtn.style.display = '';
      // Remove saving indicator
      const savingIndicator = field.querySelector('.saving-indicator');
      if (savingIndicator) savingIndicator.remove();
      showSaved(field);
      
      // Create proper field label for toast message
      let fieldLabel = fieldName;
      if (fieldName === 'content') fieldLabel = 'Page content';
      else if (fieldName === 'title') fieldLabel = resourceType === 'book' ? 'Book title' : resourceType === 'chapter' ? 'Chapter title' : 'Page title';
      else if (fieldName === 'description') fieldLabel = 'Chapter description';
      else if (fieldName === 'learning_outcome') fieldLabel = 'Learning outcome';
      else if (fieldName === 'reading_level') fieldLabel = 'Reading level';
      
      showSaveToast(fieldLabel + ' saved!');
      
      // If page content was updated, also update the image description textarea
      if (resourceType === 'page' && fieldName === 'content') {
        const pageId = resourceId;
        const textarea = document.getElementById(`image_description_${pageId}`);
        if (textarea) {
          textarea.value = newValue;
        }
      }
      
      setTimeout(() => hideSaved(field), 2000);
      // Try to parse as JSON, but don't fail if it's HTML
      const contentType = res.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        return res.json();
      }
      return res.text();
    } else {
      console.error('Save failed with status:', res.status);
      return res.text().then(text => {
        console.error('Response body:', text);
        try {
          const err = JSON.parse(text);
          console.error('Parsed error:', err);
          alert('Failed to save (Status ' + res.status + '): ' + (err.error || err.message || text));
        } catch (e) {
          // If response is HTML error page, extract the error message
          if (text.includes('Exception caught')) {
            alert('Failed to save (Status ' + res.status + '): Server error. Check console for details.');
          } else {
            alert('Failed to save (Status ' + res.status + '): ' + text);
          }
        }
        field.classList.remove('edit-mode');
      });
    }
  })
  .catch(err => {
    console.error('Fetch error:', err);
    console.error('Full error:', err);
    alert('Error saving changes: ' + err.message);
    field.classList.remove('edit-mode');
  });
}

function cancelEdit(button) {
  const actions = button.closest('.flex');
  const field = actions.closest('.editable-field');
  const editBtn = field.querySelector('.edit-btn');
  
  // Remove the actions div
  actions.remove();
  
  // Show edit button again
  editBtn.style.display = '';
  
  // Reload to restore original content
  location.reload();
}

function showSaving(element) {
  const indicator = document.createElement('span');
  indicator.className = 'saving-indicator';
  element.closest('.editable-field')?.appendChild(indicator);
}

function showSaved(field) {
  const indicator = document.createElement('span');
  indicator.className = 'saved-indicator';
  field.appendChild(indicator);
}

function hideSaved(field) {
  const indicator = field.querySelector('.saved-indicator');
  if (indicator) indicator.remove();
}

// Image Management Functions
function uploadPageImage(pageId, event) {
  const file = event.target.files[0];
  if (!file) return;

  // Show loading indicator
  showImageLoading(pageId);

  const formData = new FormData();
  formData.append('page[image]', file);

  const csrfToken = document.querySelector('[name="csrf-token"]').content;
  const bookId = document.querySelector('#book-builder-container').dataset.bookId;
  const chapterId = document.querySelector(`[data-page-id="${pageId}"]`).closest('.chapter-builder-block').dataset.chapterId;

  fetch(`/books/${bookId}/chapters/${chapterId}/pages/${pageId}.json`, {
    method: 'PATCH',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRF-Token': csrfToken
    },
    body: formData
  })
  .then(res => {
    if (res.ok) {
      return res.json();
    } else {
      throw new Error('Failed to upload image');
    }
  })
  .then(data => {
    hideImageLoading(pageId);
    showImageSuccessToast('Image uploaded successfully!');
    setTimeout(() => {
      location.reload();
    }, 500);
  })
  .catch(err => {
    console.error('Image upload error:', err);
    hideImageLoading(pageId);
    alert('Failed to upload image: ' + err.message);
  });
}

function submitBuilderGenerateImage(pageId) {
  const textarea = document.getElementById(`image_description_${pageId}`);
  const prompt = textarea.value.trim();
  
  if (!prompt) {
    alert('Please enter a description for the image');
    return;
  }

  // Show loading indicator
  showImageLoading(pageId);

  const csrfToken = document.querySelector('[name="csrf-token"]').content;
  const bookId = document.querySelector('#book-builder-container').dataset.bookId;
  const chapterId = document.querySelector(`[data-page-id="${pageId}"]`).closest('.chapter-builder-block').dataset.chapterId;

  fetch(`/books/${bookId}/chapters/${chapterId}/pages/${pageId}/generate_image.json`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({ prompt: prompt })
  })
  .then(res => {
    if (res.ok) {
      return res.json();
    } else {
      return res.json().then(data => {
        throw new Error(data.error || 'Failed to generate image');
      });
    }
  })
  .then(data => {
    hideImageLoading(pageId);
    showImageSuccessToast('Image generated successfully!');
    setTimeout(() => {
      location.reload();
    }, 500);
  })
  .catch(err => {
    console.error('Image generation error:', err);
    hideImageLoading(pageId);
    alert('Failed to generate image: ' + err.message);
  });
}

// Auto-sync page content to image description textarea (debounced)
function setupImageDescriptionSync(pageId) {
  const contentId = `editable-content-${pageId}`;
  const aiDescId = `image_description_${pageId}`;
  const debounceDelay = 700;
  let aiEdited = false;
  let debounceTimer = null;

  function syncAI() {
    if (!aiEdited) {
      const content = document.querySelector(`[data-resource-id="${pageId}"].editable-field .editable-content`);
      const aiDesc = document.getElementById(aiDescId);
      if (content && aiDesc) {
        aiDesc.value = content.innerText.trim();
      }
    }
  }

  function setupSync() {
    const content = document.querySelector(`[data-resource-id="${pageId}"].editable-field .editable-content`);
    const aiDesc = document.getElementById(aiDescId);
    if (!(content && aiDesc)) return;

    aiEdited = false;
    aiDesc.addEventListener('input', function() {
      aiEdited = true;
    });
    
    // Watch for content changes (when user edits inline)
    const observer = new MutationObserver(() => {
      if (aiEdited) return;
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(syncAI, debounceDelay);
    });
    
    observer.observe(content, { childList: true, subtree: true, characterData: true });
  }

  setupSync();
}

// Call setup on document load for each page
document.addEventListener('turbo:load', function() {
  const pages = document.querySelectorAll('[data-page-id]');
  pages.forEach(pageEl => {
    const pageId = pageEl.dataset.pageId;
    setupImageDescriptionSync(pageId);
  });
});

document.addEventListener('DOMContentLoaded', function() {
  const pages = document.querySelectorAll('[data-page-id]');
  pages.forEach(pageEl => {
    const pageId = pageEl.dataset.pageId;
    setupImageDescriptionSync(pageId);
  });
});

function deletePageImage(pageId) {
  if (!confirm('Are you sure you want to delete this image?')) {
    return;
  }

  // Show loading indicator
  showImageLoading(pageId);

  const csrfToken = document.querySelector('[name="csrf-token"]').content;
  const bookId = document.querySelector('#book-builder-container').dataset.bookId;
  const chapterId = document.querySelector(`[data-page-id="${pageId}"]`).closest('.chapter-builder-block').dataset.chapterId;

  fetch(`/books/${bookId}/chapters/${chapterId}/pages/${pageId}/delete_image.json`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRF-Token': csrfToken
    }
  })
  .then(res => {
    if (res.ok) {
      return res.json();
    } else {
      throw new Error('Failed to delete image');
    }
  })
  .then(data => {
    hideImageLoading(pageId);
    showImageSuccessToast('Image deleted successfully!');
    setTimeout(() => {
      location.reload();
    }, 500);
  })
  .catch(err => {
    console.error('Image deletion error:', err);
    hideImageLoading(pageId);
    alert('Failed to delete image: ' + err.message);
  });
}

function showImageLoading(pageId) {
  const loading = document.getElementById(`loading-${pageId}`);
  if (loading) {
    loading.classList.remove('hidden');
  }
  
  // Disable buttons
  const actions = document.getElementById(`image-actions-${pageId}`);
  if (actions) {
    const buttons = actions.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);
  }
}

function hideImageLoading(pageId) {
  const loading = document.getElementById(`loading-${pageId}`);
  if (loading) {
    loading.classList.add('hidden');
  }
  
  // Re-enable buttons
  const actions = document.getElementById(`image-actions-${pageId}`);
  if (actions) {
    const buttons = actions.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = false);
  }
}

function showImageSuccessToast(message) {
  const toast = document.createElement('div');
  toast.className = 'fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white';
  toast.style.cssText = 'background-color: #10b981; border: 1px solid #059669;';
  toast.innerHTML = `
    <div class="flex items-center gap-2">
      <i class="fas fa-check-circle"></i>
      <span>${message}</span>
    </div>
  `;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 2000);
}

</script>
