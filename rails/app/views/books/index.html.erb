<% content_for :header, "Your Books" %>

<!-- Add Book Button Section -->
<div class="mb-6">
  <% if current_user.staff? || current_user.admin? %>
    <%= link_to new_book_path, class: "btn gap-2 !bg-indigo-100 !text-indigo-700 !border-indigo-200 hover:!bg-indigo-200 hover:!border-indigo-300", style: "background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe;" do %>
      <i class="fas fa-plus"></i>
      Add Book
    <% end %>
  <% end %>
</div>

<% if @books.any? %>
  <!-- Books Grid -->
  <div class="grid gap-6 md:grid-cols-1 lg:grid-cols-1">
    <% @books.each do |book| %>
      <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow duration-200">
        <div class="card-body">
          <!-- Book Title & Status -->
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <h2 class="card-title text-2xl flex-grow">
              <%= link_to book.title, book_chapters_path(book), class: "link link-primary hover:link-hover" %>
            </h2>
            
            <% if book.status.present? %>
              <div class="badge badge-lg" style="<%= case book.status
                when 'Draft' then 'background-color: #fef3c7; color: #b45309; border-color: #fde68a;'
                when 'Published' then 'background-color: #d1fae5; color: #047857; border-color: #a7f3d0;'
                when 'Archived' then 'background-color: #f1f5f9; color: #475569; border-color: #e2e8f0;'
                else 'background-color: #f3f4f6; color: #4b5563; border-color: #e5e7eb;' end %>">
                <%= book.status %>
              </div>
            <% end %>
            
            <% if book.status == 'Published' %>
              <%= link_to public_book_path(book), target: "_blank", rel: "noopener", class: "btn btn-xs gap-1", style: "background-color: #f0f9ff; color: #0369a1; border-color: #e0f2fe;" do %>
                <i class="fas fa-share-nodes"></i>
                Share
              <% end %>
              
              <% if book.pages.any? && book.pages.all? { |page| page.audio_file.attached? } %>
                <div class="badge gap-1" style="background-color: #ccfbf1; color: #0f766e; border-color: #99f6e4;">
                  <i class="fas fa-volume-up"></i>
                  Audio
                </div>
              <% end %>
            <% end %>
          </div>

          <!-- Book Details -->
          <div class="space-y-1 mb-4">
            <div class="flex items-center gap-2 text-sm">
              <i class="fas fa-book-reader text-base-content/60"></i>
              <span class="text-base-content/70">Reading Level:</span>
              <span class="font-medium"><%= book.reading_level.presence || 'Not specified' %></span>
            </div>
            <div class="flex items-start gap-2 text-sm">
              <i class="fas fa-bullseye text-base-content/60 mt-1"></i>
              <span class="text-base-content/70">Learning Outcome:</span>
              <span class="font-medium flex-1"><%= book.learning_outcome.presence || 'Not specified' %></span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card-actions justify-start flex-wrap">
            <% if current_user.staff? || current_user.admin? %>
              <% if book.status != 'Published' %>
                <%= link_to edit_book_path(book), class: "btn btn-sm gap-1", style: "background-color: #fef3c7; color: #b45309; border-color: #fde68a;" do %>
                  <i class="fas fa-edit"></i>
                  Edit
                <% end %>
              <% end %>
              
              <% if ['Draft', 'Archived'].include?(book.status) %>
                <%= button_to publish_book_path(book), method: :patch, data: { confirm: 'Are you sure? This will publish the book.' }, class: "btn btn-sm gap-1", style: "background-color: #d1fae5; color: #047857; border-color: #a7f3d0;" do %>
                  <i class="fas fa-check-circle"></i>
                  Publish
                <% end %>
              <% end %>
              
              <% if book.status == 'Published' %>
                <%= button_to archive_book_path(book), method: :patch, data: { confirm: 'Are you sure? This will move the book to archive.' }, class: "btn btn-sm gap-1", style: "background-color: #f1f5f9; color: #334155; border-color: #e2e8f0;" do %>
                  <i class="fas fa-archive"></i>
                  Archive
                <% end %>
              <% end %>
              
              <%= link_to book_path(book), data: { turbo_method: :delete, turbo_confirm: 'Are you sure you want to delete this book?' }, class: "btn btn-sm gap-1", style: "background-color: #ffe4e6; color: #be123c; border-color: #fecdd3;" do %>
                <i class="fas fa-trash"></i>
                Delete
              <% end %>
              
            <% elsif current_user.student? && book.status == 'Published' %>
              <% if current_user.saved_books_library.exists?(id: book.id) %>
                <button class="btn btn-sm btn-disabled gap-1" style="background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe;">
                  <i class="fas fa-check"></i>
                  Saved
                </button>
                <%= button_to unsave_book_path(book), method: :delete, form: { data: { turbo: "false" } }, data: { turbo_confirm: 'Are you sure?' }, class: "btn btn-sm gap-1", style: "background-color: #fff1f2; color: #be123c; border-color: #fecdd3;" do %>
                  <i class="fas fa-times"></i>
                  Remove from Library
                <% end %>
              <% else %>
                <%= button_to save_book_path(book), method: :post, form: { data: { turbo: "false" } }, class: "btn btn-sm gap-1", style: "background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe;" do %>
                  <i class="fas fa-plus"></i>
                  Add to My Library
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <!-- Empty State -->
  <div class="card bg-base-100 shadow-lg">
    <div class="card-body items-center text-center">
      <i class="fas fa-book-open text-6xl text-indigo-200 mb-4"></i>
      <h3 class="card-title text-slate-600">No books yet</h3>
      <p class="text-slate-500">Get started by adding your first book!</p>
      <% if current_user.staff? || current_user.admin? %>
        <div class="card-actions">
          <%= link_to new_book_path, class: "btn gap-2 mt-4", style: "background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe;" do %>
            <i class="fas fa-plus"></i>
            Add Your First Book
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
