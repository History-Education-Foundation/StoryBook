<%# == Page Edit / New == %>
<%= form_with model: [@book, @chapter, page], html: { multipart: true } do |f| %>
  <div class="mb-4">
    <%= f.label :content, class: "block font-bold mb-1" %>
    <%= f.text_area :content, class: "w-full border rounded px-3 py-2 resize-y", rows: 4 %>
  </div>

  <!-- Image Management Section -->
  <div class="mb-6" id="image-container-<%= page.id %>">
    <label class="block font-bold mb-3">Image</label>
    
    <% if page.image.attached? %>
      <!-- Image Display with Checkbox to Delete -->
      <div class="mb-4">
        <div class="flex justify-center mb-4">
          <%= image_tag page.image, class: "rounded-lg border-2 max-h-80 object-contain", style: "border-color: #e0e7ff;", loading: "lazy", alt: "" %>
        </div>
        <div class="flex items-center gap-2 p-3 rounded bg-red-50 border border-red-200">
          <%= f.check_box :delete_image, { class: "w-4 h-4 text-red-600 rounded cursor-pointer" }, "true", "false" %>
          <label for="page_delete_image" class="text-sm text-red-700 cursor-pointer font-medium">Delete this image (will be removed when you save)</label>
        </div>
      </div>
    <% else %>
      <!-- Placeholder -->
      <div class="flex justify-center mb-4">
        <div class="rounded-lg border-2 border-dashed p-8 text-center" style="border-color: #e0e7ff; background-color: #f3f4f6; width: 100%; max-width: 400px;">
          <i class="fas fa-image text-4xl mb-2" style="color: #9ca3af;"></i>
          <p class="text-gray-500 text-sm">No image yet</p>
        </div>
      </div>
    <% end %>

    <!-- File Input -->
    <div class="w-full">
      <%= f.file_field :image, direct_upload: true, class: "w-full border rounded px-3 py-2" %>
    </div>
  </div>

  <div class="mb-4">
    <%= f.label :audio_file, "Audio File", class: "block font-bold mb-1" %>
    <%= f.file_field :audio_file, direct_upload: true, class: "w-full border rounded px-3 py-2" %>
    <% if page.audio_file.attached? %>
      <div class="mt-2">
        <audio controls>
          <source src="<%= url_for(page.audio_file) %>">
          Your browser does not support the audio element.
        </audio>
      </div>
    <% end %>
  </div>

  <div class="flex gap-4 items-center">
    <%= f.submit "Save", class: "bg-purple-600 text-white font-bold px-4 py-2 rounded hover:bg-purple-700" %>
    <% if page.persisted? %>
      <%= link_to "Cancel", book_chapter_pages_path(@book, @chapter), class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold px-4 py-2 rounded" %>
    <% end %>
  </div>
<% end %>

<%# == AI Image Generation (separate form; NOT nested) == %>
<% if page.persisted? %>
<div class="mb-8 mt-10">
  <div class="relative flex flex-col items-center">
    <div class="text-center mb-2 text-gray-700 font-semibold">OR generate an image with AI</div>
    <div class="max-w-md w-full">
      <%= form_with url: generate_image_book_chapter_page_path(@book, @chapter, page),
                    method: :post,
                    id: "ai-image-form" do |g| %>
        <div class="mb-2">
          <%= g.label :image_description, "Describe the image you want" %>
          <textarea class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full resize-y" rows="3" name="image_description" id="image_description"><%= page.content.presence || '' %></textarea>
        </div>
        <div>
          <%= g.submit "Generate Image",
                class: "w-full rounded bg-indigo-600 py-2 px-4 text-white font-semibold hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75" %>
        </div>
      <% end %>

      <div id="loading-indicator" class="hidden text-center mt-4">
        <span class="loader inline-block align-middle"></span>
        <span class="ml-2 align-middle">Generating image, please wait...</span>
      </div>
    </div>
  </div>
</div>
<% end %>

<script>
  function wireAiFormSpinner() {
    const form = document.getElementById("ai-image-form");
    const loading = document.getElementById("loading-indicator");
    if (!form || !loading) return;

    // Turbo events (Rails 7)
    form.addEventListener("turbo:submit-start", function () {
      loading.classList.remove("hidden");
    });
    form.addEventListener("turbo:submit-end", function () {
      loading.classList.add("hidden");
    });

    // Fallback if Turbo not present
    form.addEventListener("submit", function () {
      loading.classList.remove("hidden");
    });
  }

  document.addEventListener("turbo:load", wireAiFormSpinner);
  document.addEventListener("DOMContentLoaded", wireAiFormSpinner);
</script>

<style>
  .loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #6366f1;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
<script>
(function() {
  // Debounced sync from content to AI textarea UNTIL user manually edits the AI textarea
  var contentId = 'page_content';
  var aiId = 'image_description';
  var debounceDelay = 700;
  var aiEdited = false;
  var debounceTimer = null;

  function syncAI() {
    if (!aiEdited) {
      var content = document.getElementById(contentId);
      var aiDesc = document.getElementById(aiId);
      if (content && aiDesc) {
        aiDesc.value = content.value;
      }
    }
  }

  function setupSync() {
    var content = document.getElementById(contentId);
    var aiDesc = document.getElementById(aiId);
    if (!(content && aiDesc)) return;
    aiEdited = false;
    aiDesc.addEventListener('input', function() {
      aiEdited = true;
    });
    content.addEventListener('input', function() {
      if (aiEdited) return;
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(syncAI, debounceDelay);
    });
  }
  document.addEventListener('DOMContentLoaded', setupSync);
  document.addEventListener('turbo:load', setupSync);
})();
</script>

<script>
(function() {
  // IDs of the content and AI desc textareas
  var contentId = 'page_content';
  var aiId = 'image_description';
  var debounceDelay = 700;
  var aiEdited = false;
  var debounceTimer = null;

  function syncAI() {
    if (!aiEdited) {
      var content = document.getElementById(contentId);
      var aiDesc = document.getElementById(aiId);
      if (content && aiDesc) {
        aiDesc.value = content.value;
      }
    }
  }

  function setupSync() {
    var content = document.getElementById(contentId);
    var aiDesc = document.getElementById(aiId);
    if (!(content && aiDesc)) return;

    aiDesc.addEventListener('input', function() {
      aiEdited = true;
    });
    content.addEventListener('input', function() {
      if (aiEdited) return;
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(syncAI, debounceDelay);
    });
  }
  document.addEventListener('DOMContentLoaded', setupSync);
  document.addEventListener('turbo:load', setupSync);
})();
</script>
